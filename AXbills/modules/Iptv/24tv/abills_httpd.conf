# AXbills apache configuration. Default ABillS port is 9443
# Config for apache 2.2 and apache 2.4
Listen 8443

# Alias for MRTG web reports directory
Alias "/reports" "/usr/axbills/webreports"
<Directory "/usr/axbills/webreports">
  AllowOverride All
  Order allow,deny
  Allow from all
  Require all granted
  Satisfy Any
</Directory>

# Main server config
<VirtualHost _default_:443>

ProxyPass "/admin/wss/" "ws://127.0.0.1:19443/wss/admin/" retry=1

  AddDefaultCharset utf-8

  DocumentRoot "/usr/axbills/cgi-bin"
  ServerName my.server.name
  ServerAdmin support@server.name
  ErrorLog /var/log/httpd/axbills-error.log

  #TransferLog /var/log/httpd/axbills-access.log
  CustomLog /var/log/httpd/axbills-access_log common

  <IfModule ssl_module>
    #   SSL Engine Switch:
    #   Enable/Disable SSL for this virtual host.
    SSLEngine on
    SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
    SSLCertificateFile /etc/letsencrypt/live/my.server.name/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/my.server.name/privkey.pem
    #SSLCACertificateFile  /usr/axbills/Certs/gd_bundle.crt

     #Test cache option
     SSLSessionCacheTimeout 300

    <FilesMatch "\.(cgi)$">
      SSLOptions +StdEnvVars
    </FilesMatch>
    BrowserMatch ".*MSIE.*" \
           nokeepalive ssl-unclean-shutdown \
           downgrade-1.0 force-response-1.0

    CustomLog /var/log/httpd/axbills-ssl_request.log \
            "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"
  </IfModule>


  Alias "/images" "/usr/axbills/AXbills/templates"
  <Directory "/usr/axbills/AXbills/templates">
    AllowOverride None
    Order allow,deny
    Deny from all

    <FilesMatch "\.(jpg|gif|png|css|js|JPG|GIF|PNG)$">
      Order deny,allow
      Allow from all
      Require all granted
      Satisfy Any
    </FilesMatch>
  </Directory>


  # User interface
  <Directory "/usr/axbills/cgi-bin">
    <IfModule ssl_module>
      SSLOptions +StdEnvVars
    </IfModule>

    <IfModule mod_rewrite.c>
      RewriteEngine on
      RewriteCond %{HTTP:Authorization} ^(.*)
      RewriteRule ^(.*) - [E=HTTP_CGI_AUTHORIZATION:%1]

      #Anti TRACE
      RewriteCond %{REQUEST_METHOD} ^TRACE
      RewriteRule .* - [F]

      Options Indexes ExecCGI SymLinksIfOwnerMatch
    </IfModule>

    AddHandler cgi-script .cgi
    Options Indexes ExecCGI FollowSymLinks
    AllowOverride none
    DirectoryIndex index.cgi

    Order allow,deny
    Allow from all

    Require all granted
    Satisfy Any

    <Files ~ "\.(db|log)$">
      Order allow,deny
      Deny from all
    </Files>
  </Directory>

  #Admin interface
  <Directory "/usr/axbills/cgi-bin/admin">

    <IfModule ssl_module>
      SSLOptions +StdEnvVars
    </IfModule>

    AddHandler cgi-script .cgi
    Options Indexes ExecCGI FollowSymLinks

    AllowOverride none
    DirectoryIndex index.cgi

    Order deny,allow
    Allow from all

    Require all granted
    Satisfy Any
  </Directory>

  <Directory "/usr/axbills/cgi-bin/captcha">
    <FilesMatch "\.(txt)$">
      Order deny,allow
      Deny from all
    </FilesMatch>
    Options -Indexes
  </Directory>

<Directory "/usr/axbills/cgi-bin">
     RewriteEngine On
     RewriteRule auth /get_pl.cgi?&%{QUERY_STRING}
     RewriteRule packet /get_pl.cgi?&%{QUERY_STRING}
     RewriteRule delete_subscription /get_pl.cgi?&%{QUERY_STRING}
</Directory>

Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
